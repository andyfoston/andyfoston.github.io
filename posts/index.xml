<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on Andy's Blog</title><link>/posts/</link><description>Recent content in Posts on Andy's Blog</description><generator>Hugo -- gohugo.io</generator><language>en-gb</language><lastBuildDate>Thu, 26 Aug 2021 00:00:00 +0000</lastBuildDate><atom:link href="/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Processing Kenesis Firehose logs for Splunk</title><link>/posts/splunk-firehose-lambda/</link><pubDate>Thu, 26 Aug 2021 00:00:00 +0000</pubDate><guid>/posts/splunk-firehose-lambda/</guid><description>For a project at work, we needed to set up Kinesis Firehose to send logs from a provider’s logging infrastructure (New Relic) into our logging infrastructure.
This by itself partly solved our use case, but there was a huge amount of logs that were coming in which was essentially noise, and the logs that were coming in were for both nonproduction and production and they were being routed to the same index.</description><content>&lt;p>For a project at work, we needed to set up Kinesis Firehose to send logs from a provider’s logging
infrastructure (New Relic) into our logging infrastructure.&lt;/p>
&lt;p>This by itself partly solved our use case, but there was a huge amount of logs that were coming
in which was essentially noise, and the logs that were coming in were for both nonproduction and
production and they were being routed to the same index.&lt;/p>
&lt;p>There were many ways we could have solved this:&lt;/p>
&lt;ol>
&lt;li>By asking New Relic to set up filtering/routing on their side (not ideal as we are not the owners of
this account and it depends on 3rd parties doing this work for us)&lt;/li>
&lt;li>Configuring our Splunk Heavy Forwarder to preprocess these before forwarding to Splunk Cloud,
but this wasn’t a redundant service and would have meant that if the Heavy Forwarder had issues,
then we’d lose logging for some time.&lt;/li>
&lt;/ol>
&lt;p>In the end, we decided to use a Golang lambda to process these. To be honest, I found the
documentation a little sparse for doing this and figured it could be a good opportunity to help
others who are trying to do something similar to me.&lt;/p>
&lt;h2 id="skeleton-lambda-example">Skeleton lambda example&lt;/h2>
&lt;p>Some of this is probably documented elsewhere, but let&amp;rsquo;s start off with a skeleton lambda:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> (
&lt;span style="color:#e6db74">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;github.com/aws/aws-lambda-go/events&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;github.com/aws/aws-lambda-go/lambda&amp;#34;&lt;/span>
)
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">handleRequest&lt;/span>(&lt;span style="color:#a6e22e">evnt&lt;/span> &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseEvent&lt;/span>) (&lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseResponse&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>) {
&lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Printf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;InvocationID: %s\n&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">evnt&lt;/span>.&lt;span style="color:#a6e22e">InvocationID&lt;/span>)
&lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Printf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;DeliveryStreamArn: %s\n&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">evnt&lt;/span>.&lt;span style="color:#a6e22e">DeliveryStreamArn&lt;/span>)
&lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Printf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Region: %s\n&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">evnt&lt;/span>.&lt;span style="color:#a6e22e">Region&lt;/span>)
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">response&lt;/span> &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseResponse&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#a6e22e">_&lt;/span>, &lt;span style="color:#a6e22e">record&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#66d9ef">range&lt;/span> &lt;span style="color:#a6e22e">evnt&lt;/span>.&lt;span style="color:#a6e22e">Records&lt;/span> {
&lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Printf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;RecordID: %s\n&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">record&lt;/span>.&lt;span style="color:#a6e22e">RecordID&lt;/span>)
&lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Printf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;ApproximateArrivalTimestamp: %s\n&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">record&lt;/span>.&lt;span style="color:#a6e22e">ApproximateArrivalTimestamp&lt;/span>)
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">transformedRecord&lt;/span> &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseResponseRecord&lt;/span>
&lt;span style="color:#a6e22e">transformedRecord&lt;/span>.&lt;span style="color:#a6e22e">RecordID&lt;/span> = &lt;span style="color:#a6e22e">record&lt;/span>.&lt;span style="color:#a6e22e">RecordID&lt;/span>
&lt;span style="color:#a6e22e">transformedRecord&lt;/span>.&lt;span style="color:#a6e22e">Result&lt;/span> = &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseTransformedStateOk&lt;/span>
&lt;span style="color:#a6e22e">transformedRecord&lt;/span>.&lt;span style="color:#a6e22e">Data&lt;/span> = &lt;span style="color:#a6e22e">record&lt;/span>.&lt;span style="color:#a6e22e">Data&lt;/span>
&lt;span style="color:#a6e22e">response&lt;/span>.&lt;span style="color:#a6e22e">Records&lt;/span> = append(&lt;span style="color:#a6e22e">response&lt;/span>.&lt;span style="color:#a6e22e">Records&lt;/span>, &lt;span style="color:#a6e22e">transformedRecord&lt;/span>)
}
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">response&lt;/span>, &lt;span style="color:#66d9ef">nil&lt;/span>
}
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;span style="color:#a6e22e">lambda&lt;/span>.&lt;span style="color:#a6e22e">Start&lt;/span>(&lt;span style="color:#a6e22e">handleRequest&lt;/span>)
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This snippet essentially does nothing to the records, but it provides a starting point to begin
processing these records.&lt;/p>
&lt;h3 id="support-routing-records-to-splunk-indexes-other-than-the-default">Support routing records to Splunk indexes other than the default&lt;/h3>
&lt;p>It is possible to inject an index name into the payload for Splunk, however there are a
few things that need to be done first.&lt;/p>
&lt;p>Firstly, the Splunk HEC needs to have permission to write to all indexes that you plan to use
here. If you do not, Splunk will likely reject them and they&amp;rsquo;ll likely end up being written
to the S3 bucket for unprocessable events (assuming you&amp;rsquo;ve set this up).&lt;/p>
&lt;p>The other thing is that the &amp;lsquo;Raw endpoint&amp;rsquo; will ignore the index parameter, and it&amp;rsquo;ll just become part
of the logging payload stored in Splunk.&lt;/p>
&lt;p>To fix this, you&amp;rsquo;ll need to change the Splunk endpoint type to use an &amp;lsquo;Event endpoint&amp;rsquo;. However, this
requires some more changes to our lambda in order to work:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> (
&lt;span style="color:#e6db74">&amp;#34;encoding/json&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;strings&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;github.com/aws/aws-lambda-go/events&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;github.com/aws/aws-lambda-go/lambda&amp;#34;&lt;/span>
)
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">formatRecordForSplunk&lt;/span>(&lt;span style="color:#a6e22e">data&lt;/span> &lt;span style="color:#66d9ef">map&lt;/span>[&lt;span style="color:#66d9ef">string&lt;/span>]&lt;span style="color:#a6e22e">json&lt;/span>.&lt;span style="color:#a6e22e">RawMessage&lt;/span>, &lt;span style="color:#a6e22e">index&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>) ([]&lt;span style="color:#66d9ef">byte&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>) {
&lt;span style="color:#a6e22e">response&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> make(&lt;span style="color:#66d9ef">map&lt;/span>[&lt;span style="color:#66d9ef">string&lt;/span>]&lt;span style="color:#a6e22e">json&lt;/span>.&lt;span style="color:#a6e22e">RawMessage&lt;/span>)
&lt;span style="color:#a6e22e">response&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;time&amp;#34;&lt;/span>] = &lt;span style="color:#a6e22e">data&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;timestamp&amp;#34;&lt;/span>]
&lt;span style="color:#a6e22e">response&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;sourcetype&amp;#34;&lt;/span>] = &lt;span style="color:#a6e22e">json&lt;/span>.&lt;span style="color:#a6e22e">RawMessage&lt;/span>(&lt;span style="color:#e6db74">`&amp;#34;_json&amp;#34;`&lt;/span>)
&lt;span style="color:#a6e22e">response&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;host&amp;#34;&lt;/span>] = &lt;span style="color:#a6e22e">data&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;cluster&amp;#34;&lt;/span>]
&lt;span style="color:#a6e22e">response&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;source&amp;#34;&lt;/span>] = &lt;span style="color:#a6e22e">data&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;eventType&amp;#34;&lt;/span>]
&lt;span style="color:#a6e22e">event&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">json&lt;/span>.&lt;span style="color:#a6e22e">Marshal&lt;/span>(&lt;span style="color:#a6e22e">data&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> []byte(&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>), &lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Errorf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Failed to marshal event \&amp;#34;%s\&amp;#34;. Error: %s\n&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">data&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span>)
} &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;span style="color:#a6e22e">response&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;event&amp;#34;&lt;/span>] = &lt;span style="color:#a6e22e">event&lt;/span>
}
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">index&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span> {
&lt;span style="color:#a6e22e">response&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;index&amp;#34;&lt;/span>] = []byte(&lt;span style="color:#a6e22e">index&lt;/span>)
}
&lt;span style="color:#a6e22e">marshalledResponse&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">json&lt;/span>.&lt;span style="color:#a6e22e">Marshal&lt;/span>(&lt;span style="color:#a6e22e">response&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> []byte(&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>), &lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Errorf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Failed to marshal splunk record \&amp;#34;%s\&amp;#34;. Error %s\n&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">response&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span>)
}
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">marshalledResponse&lt;/span>, &lt;span style="color:#66d9ef">nil&lt;/span>
}
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">processRecord&lt;/span>(&lt;span style="color:#a6e22e">record&lt;/span> &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseRecord&lt;/span>) (&lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseResponseRecord&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>) {
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">data&lt;/span> &lt;span style="color:#66d9ef">map&lt;/span>[&lt;span style="color:#66d9ef">string&lt;/span>]&lt;span style="color:#a6e22e">json&lt;/span>.&lt;span style="color:#a6e22e">RawMessage&lt;/span>
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">transformedRecord&lt;/span> &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseResponseRecord&lt;/span>
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">index&lt;/span> &lt;span style="color:#66d9ef">string&lt;/span>
&lt;span style="color:#a6e22e">transformedRecord&lt;/span>.&lt;span style="color:#a6e22e">RecordID&lt;/span> = &lt;span style="color:#a6e22e">record&lt;/span>.&lt;span style="color:#a6e22e">RecordID&lt;/span>
&lt;span style="color:#a6e22e">transformedRecord&lt;/span>.&lt;span style="color:#a6e22e">Result&lt;/span> = &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseTransformedStateOk&lt;/span>
&lt;span style="color:#a6e22e">transformedRecord&lt;/span>.&lt;span style="color:#a6e22e">Data&lt;/span> = &lt;span style="color:#a6e22e">record&lt;/span>.&lt;span style="color:#a6e22e">Data&lt;/span>
&lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">json&lt;/span>.&lt;span style="color:#a6e22e">Unmarshal&lt;/span>(&lt;span style="color:#a6e22e">record&lt;/span>.&lt;span style="color:#a6e22e">Data&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">data&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;span style="color:#a6e22e">transformedRecord&lt;/span>.&lt;span style="color:#a6e22e">Result&lt;/span> = &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseTransformedStateFailed&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">transformedRecord&lt;/span>
}
&lt;span style="color:#a6e22e">cluster&lt;/span>, &lt;span style="color:#a6e22e">ok&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">data&lt;/span>[&lt;span style="color:#e6db74">&amp;#34;cluster&amp;#34;&lt;/span>]
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">ok&lt;/span> {
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">strings&lt;/span>.&lt;span style="color:#a6e22e">Contains&lt;/span>(string(&lt;span style="color:#a6e22e">cluster&lt;/span>), &lt;span style="color:#e6db74">&amp;#34;dev&amp;#34;&lt;/span>) {
&lt;span style="color:#a6e22e">index&lt;/span> = &lt;span style="color:#e6db74">&amp;#34;dev_index&amp;#34;&lt;/span>
}
}
&lt;span style="color:#a6e22e">splunkRecord&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">formatRecordForSplunk&lt;/span>(&lt;span style="color:#a6e22e">data&lt;/span>, &lt;span style="color:#a6e22e">index&lt;/span>)
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span> {
&lt;span style="color:#a6e22e">transformedRecord&lt;/span>.&lt;span style="color:#a6e22e">Result&lt;/span> = &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseTransformedStateFailed&lt;/span>
} &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;span style="color:#a6e22e">transformedRecord&lt;/span>.&lt;span style="color:#a6e22e">Data&lt;/span> = &lt;span style="color:#a6e22e">splunkRecord&lt;/span>
}
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">transformedRecord&lt;/span>
}
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">handleRequest&lt;/span>(&lt;span style="color:#a6e22e">evnt&lt;/span> &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseEvent&lt;/span>) (&lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseResponse&lt;/span>, &lt;span style="color:#66d9ef">error&lt;/span>) {
&lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Printf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;InvocationID: %s\n&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">evnt&lt;/span>.&lt;span style="color:#a6e22e">InvocationID&lt;/span>)
&lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Printf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;DeliveryStreamArn: %s\n&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">evnt&lt;/span>.&lt;span style="color:#a6e22e">DeliveryStreamArn&lt;/span>)
&lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Printf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;Region: %s\n&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">evnt&lt;/span>.&lt;span style="color:#a6e22e">Region&lt;/span>)
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">response&lt;/span> &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseResponse&lt;/span>
&lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#a6e22e">_&lt;/span>, &lt;span style="color:#a6e22e">record&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#66d9ef">range&lt;/span> &lt;span style="color:#a6e22e">evnt&lt;/span>.&lt;span style="color:#a6e22e">Records&lt;/span> {
&lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Printf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;RecordID: %s\n&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">record&lt;/span>.&lt;span style="color:#a6e22e">RecordID&lt;/span>)
&lt;span style="color:#a6e22e">fmt&lt;/span>.&lt;span style="color:#a6e22e">Printf&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;ApproximateArrivalTimestamp: %s\n&amp;#34;&lt;/span>, &lt;span style="color:#a6e22e">record&lt;/span>.&lt;span style="color:#a6e22e">ApproximateArrivalTimestamp&lt;/span>)
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">transformedRecord&lt;/span> &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseResponseRecord&lt;/span>
&lt;span style="color:#a6e22e">transformedRecord&lt;/span>.&lt;span style="color:#a6e22e">RecordID&lt;/span> = &lt;span style="color:#a6e22e">record&lt;/span>.&lt;span style="color:#a6e22e">RecordID&lt;/span>
&lt;span style="color:#a6e22e">transformedRecord&lt;/span>.&lt;span style="color:#a6e22e">Result&lt;/span> = &lt;span style="color:#a6e22e">events&lt;/span>.&lt;span style="color:#a6e22e">KinesisFirehoseTransformedStateOk&lt;/span>
&lt;span style="color:#a6e22e">transformedRecord&lt;/span>.&lt;span style="color:#a6e22e">Data&lt;/span> = &lt;span style="color:#a6e22e">record&lt;/span>.&lt;span style="color:#a6e22e">Data&lt;/span>
&lt;span style="color:#a6e22e">response&lt;/span>.&lt;span style="color:#a6e22e">Records&lt;/span> = append(&lt;span style="color:#a6e22e">response&lt;/span>.&lt;span style="color:#a6e22e">Records&lt;/span>, &lt;span style="color:#a6e22e">transformedRecord&lt;/span>)
}
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">response&lt;/span>, &lt;span style="color:#66d9ef">nil&lt;/span>
}
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>() {
&lt;span style="color:#a6e22e">lambda&lt;/span>.&lt;span style="color:#a6e22e">Start&lt;/span>(&lt;span style="color:#a6e22e">handleRequest&lt;/span>)
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>This returns an object containing a few key fields that are required by Splunk, like the &lt;code>source&lt;/code>, &lt;code>sourcetype&lt;/code>, &lt;code>host&lt;/code>, &lt;code>time&lt;/code>
and optionally the &lt;code>index&lt;/code> field, the actual event payload is then written to the &lt;code>event&lt;/code> field.&lt;/p>
&lt;h3 id="dropping-records">Dropping records&lt;/h3>
&lt;p>From the above, you may have noticed lines like &lt;code>transformedRecord.Result = events.KinesisFirehoseTransformedStateFailed&lt;/code> lines.
The &lt;code>...StateFailed&lt;/code> triggers Firehose to write the log to the backup destination (probably an S3 bucket).&lt;/p>
&lt;p>However, if you want to drop events, you can return the event payload as normal, but set the &lt;code>Result&lt;/code> to &lt;code>events.KinesisFirehoseTransformedStateDropped&lt;/code>
this&amp;rsquo;ll trigger the event to not be forwared to Splunk and not to be written to the backup destination either.&lt;/p>
&lt;h3 id="disclaimer">Disclaimer&lt;/h3>
&lt;p>The code in here is a heavy stripped down and refactored version of what we&amp;rsquo;re using for our lambda, so these versions have not
actually been tested directly, but should hopefully provide a basis to start from.&lt;/p></content></item></channel></rss>